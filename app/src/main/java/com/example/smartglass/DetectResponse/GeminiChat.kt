//package com.example.smartglass.DetectResponse
//
//import android.util.Log
//import com.google.gson.JsonParser
//import okhttp3.Call
//import okhttp3.Callback
//import okhttp3.MediaType.Companion.toMediaType
//import okhttp3.OkHttpClient
//import okhttp3.Request
//import okhttp3.RequestBody.Companion.toRequestBody
//import okhttp3.Response
//import java.io.IOException
//
//class GeminiChat(private val apiKey: String) {
//
//    private val client = OkHttpClient()
//    private val apiUrl =
//        "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent"
//
//    fun sendMessageSync(prompt: String): String? {
//        val jsonBody = """
//            {
//              "contents": [
//                {
//                  "parts": [
//                    { "text": "$prompt" }
//                  ]
//                }
//              ]
//            }
//        """.trimIndent()
//
//        val body = jsonBody.toRequestBody("application/json".toMediaType())
//
//        val request = Request.Builder()
//            .url(apiUrl)
//            .addHeader("x-goog-api-key", apiKey)
//            .addHeader("Content-Type", "application/json")
//            .post(body)
//            .build()
//
//        client.newCall(request).execute().use { response ->
//            if (!response.isSuccessful) {
//                Log.e("GeminiChat", "Request failed: ${response.code}")
//                Log.e("GeminiChat", response.body?.string() ?: "No body")
//                return null
//            }
//
//            val responseBody = response.body?.string() ?: return null
//            Log.d("GeminiRaw", "Gemini raw response: $responseBody")
//
//            val textResponse = extractTextResponse(responseBody)
//            Log.d("GeminiChat", "Gemini tr·∫£ l·ªùi: $textResponse")
//
//            return textResponse
//        }
//    }
//
//    fun sendMessageAsync(prompt: String, callback: (String?) -> Unit) {
//        val jsonBody = """
//            {
//              "contents": [
//                {
//                  "parts": [
//                    { "text": "$prompt" }
//                  ]
//                }
//              ]
//            }
//        """.trimIndent()
//
//        val body = jsonBody.toRequestBody("application/json".toMediaType())
//        val request = Request.Builder()
//            .url(apiUrl)
//            .addHeader("x-goog-api-key", apiKey)
//            .addHeader("Content-Type", "application/json")
//            .post(body)
//            .build()
//
//        client.newCall(request).enqueue(object : Callback {
//            override fun onFailure(call: Call, e: IOException) {
//                e.printStackTrace()
//                callback(null)
//            }
//
//            override fun onResponse(call: Call, response: Response) {
//                response.use {
//                    val responseBody = response.body?.string() ?: ""
//                    Log.d("GeminiRaw", "Gemini raw response: $responseBody")
//
//                    if (!response.isSuccessful) {
//                        Log.e("GeminiChat", "Request failed: ${response.code}")
//                        callback(null)
//                        return
//                    }
//
//                    try {
//                        val textResponse = extractTextResponse(responseBody)
//                        Log.d("GeminiChat", "Gemini tr·∫£ l·ªùi: $textResponse")
//
//                        val cleaned = cleanResponse(textResponse)
//                        callback(cleaned)
//                    } catch (e: Exception) {
//                        Log.e("GeminiChat", "L·ªói khi parse JSON: ${e.message}")
//                        callback(null)
//                    }
//                }
//            }
//        })
//    }
//
//    private fun extractTextResponse(responseBody: String): String? {
//        return try {
//            val json = JsonParser.parseString(responseBody).asJsonObject
//            json["candidates"]
//                ?.asJsonArray?.get(0)?.asJsonObject
//                ?.getAsJsonObject("content")?.getAsJsonArray("parts")
//                ?.get(0)?.asJsonObject?.get("text")?.asString
//        } catch (e: Exception) {
//            Log.e("GeminiChat", "L·ªói extractTextResponse: ${e.message}")
//            null
//        }
//    }
//    private fun cleanResponse(text: String?): String? {
//        if (text == null) return null
//        return text
//            .replace("**", "")
//            .replace("__", "")
//            .replace("*", "")
//            .replace("_", "")
//            .replace(Regex("\\s+"), " ")
//            .trim()
//    }
//    fun analyzeUserCommand(command: String, callback: (String?) -> Unit) {
//        val prompt = """
//        C√¢u n√≥i: "$command"
//    """.trimIndent()
//
//        sendMessageAsync(prompt) { response ->
//            callback(response)
//        }
//    }
//}


package com.example.smartglass.DetectResponse

import android.util.Log
import com.google.gson.JsonParser
import okhttp3.*
import okhttp3.MediaType.Companion.toMediaType
import okhttp3.RequestBody.Companion.toRequestBody
import java.io.IOException

class GeminiChat(private val apiKey: String) {

    private val client = OkHttpClient()
    private val apiUrl =
        "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent"

    // ---------------------- üîπ G·ª¨I ƒê·ªíNG B·ªò ----------------------
    fun sendMessageSync(prompt: String): String? {
        val escapedPrompt = prompt.replace("\"", "\\\"").replace("\n", "\\n")
        val jsonBody = """
            {
              "contents": [
                {
                  "parts": [
                    { "text": "$escapedPrompt" }
                  ]
                }
              ]
            }
        """.trimIndent()

        val body = jsonBody.toRequestBody("application/json".toMediaType())

        val request = Request.Builder()
            .url(apiUrl)
            .addHeader("x-goog-api-key", apiKey)
            .addHeader("Content-Type", "application/json")
            .post(body)
            .build()

        client.newCall(request).execute().use { response ->
            val responseBody = response.body?.string() ?: ""
            Log.d("GeminiRaw", "Gemini raw (sync): $responseBody")

            if (!response.isSuccessful) {
                Log.e("GeminiChat", "Request failed: ${response.code}")
                return null
            }

            val textResponse = extractTextResponse(responseBody)
            val cleaned = cleanResponse(textResponse)
            Log.d("GeminiChat", "Gemini tr·∫£ l·ªùi: $cleaned")
            return cleaned
        }
    }

    // ---------------------- üîπ G·ª¨I B·∫§T ƒê·ªíNG B·ªò ----------------------
    fun sendMessageAsync(prompt: String, callback: (String?) -> Unit) {
        val escapedPrompt = prompt.replace("\"", "\\\"").replace("\n", "\\n")
        val jsonBody = """
            {
              "contents": [
                {
                  "parts": [
                    { "text": "$escapedPrompt" }
                  ]
                }
              ]
            }
        """.trimIndent()

        val body = jsonBody.toRequestBody("application/json".toMediaType())
        val request = Request.Builder()
            .url(apiUrl)
            .addHeader("x-goog-api-key", apiKey)
            .addHeader("Content-Type", "application/json")
            .post(body)
            .build()

        client.newCall(request).enqueue(object : Callback {
            override fun onFailure(call: Call, e: IOException) {
                Log.e("GeminiChat", "L·ªói m·∫°ng ho·∫∑c request: ${e.message}")
                callback(null)
            }

            override fun onResponse(call: Call, response: Response) {
                response.use {
                    val responseBody = response.body?.string() ?: ""
                    Log.d("GeminiRaw", "Gemini raw (async): $responseBody")

                    if (!response.isSuccessful) {
                        Log.e("GeminiChat", "Request failed: ${response.code}")
                        callback(null)
                        return
                    }

                    if (responseBody.isEmpty()) {
                        Log.e("GeminiChat", "Response body r·ªóng.")
                        callback(null)
                        return
                    }

                    try {
                        val textResponse = extractTextResponse(responseBody)
                        val cleaned = cleanResponse(textResponse)
                        Log.d("GeminiChat", "Gemini tr·∫£ l·ªùi: $cleaned")
                        callback(cleaned)
                    } catch (e: Exception) {
                        Log.e("GeminiChat", "L·ªói khi parse JSON: ${e.message}")
                        callback(null)
                    }
                }
            }
        })
    }

    // ---------------------- üîπ H√ÄM PH√ÇN T√çCH JSON ----------------------
    private fun extractTextResponse(responseBody: String): String? {
        return try {
            val json = JsonParser.parseString(responseBody).asJsonObject
            val candidates = json["candidates"]?.asJsonArray
            if (candidates != null && candidates.size() > 0) {
                val content = candidates[0].asJsonObject["content"]?.asJsonObject
                val parts = content?.getAsJsonArray("parts")
                val firstText = parts?.firstOrNull()?.asJsonObject?.get("text")?.asString
                firstText ?: "Kh√¥ng c√≥ ph·∫£n h·ªìi t·ª´ Gemini."
            } else {
                Log.e("GeminiChat", "Kh√¥ng t√¨m th·∫•y tr∆∞·ªùng 'candidates'.")
                null
            }
        } catch (e: Exception) {
            Log.e("GeminiChat", "L·ªói extractTextResponse: ${e.message}")
            null
        }
    }

    // ---------------------- üîπ L√ÄM S·∫†CH PH·∫¢N H·ªíI ----------------------
    private fun cleanResponse(text: String?): String? {
        if (text == null) return null
        return text
            .replace("**", "")
            .replace("__", "")
            .replace("*", "")
            .replace("_", "")
            .replace(Regex("\\s+"), " ")
            .trim()
    }

    // ---------------------- üîπ H√ÄM PH√ÇN T√çCH L·ªÜNH ----------------------
    fun analyzeUserCommand(command: String, callback: (String?) -> Unit) {
        val prompt = """
        C√¢u n√≥i: "$command"
        H√£y tr√≠ch ra t·ª´ kh√≥a ch√≠nh, v√≠ d·ª•: "√¢m l∆∞·ª£ng", "t·ªëc ƒë·ªô", "v·ªã tr√≠", "k·∫øt n·ªëi", "trang ch·ªß", "c√†i ƒë·∫∑t".
        Ch·ªâ tr·∫£ v·ªÅ ƒë√∫ng t·ª´ kh√≥a, kh√¥ng th√™m gi·∫£i th√≠ch.
        """.trimIndent()

        sendMessageAsync(prompt) { response ->
            callback(response)
        }
    }
}
